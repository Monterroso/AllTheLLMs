# Technical Specification

## System Overview
The system is designed to manage and interact with Discord servers using a custom Discord bot. The bot facilitates various functionalities such as enabling/disabling bot personalities, listing enabled bots, and processing messages to generate responses using Large Language Models (LLMs). The system comprises several components including backend services, a database, and external APIs for LLM interactions.

### Main Components and Their Roles
- **Backend Services**: Handle business logic, interact with the database, and communicate with Discord and LLM APIs.
- **Database**: Stores bot configurations, server information, and relationships between servers and bots.
- **External APIs**: Interface with LLM providers (e.g., OpenAI, Anthropic, Gemini) to generate responses.
- **Commands**: Define user interactions via Discord commands.
- **Events**: Handle Discord events such as message creation and client readiness.
- **Utilities**: Provide encryption and logging functionalities.

## Core Functionality
### Primary Features and Their Implementation

1. **Bot Configuration Management**
   - **File**: `services/discord.ts`
   - **Functions**: 
     - `enableBotForServer(serverId: string, alias: string)`: Enables a bot personality for a server.
     - `getServerBots(serverId: string)`: Retrieves all bot personalities enabled for a server.
     - `stopRespondingInServer(serverId: string)`: Stops the bot from responding in a server.
     - `resumeRespondingInServer(serverId: string)`: Resumes the bot responding in a server.
   - **Description**: These functions manage the state of bot personalities within servers, allowing administrators to control bot behavior.

2. **Message Processing and Response Generation**
   - **File**: `services/discord.ts`
   - **Functions**: 
     - `processMessage(message: Message)`: Processes a Discord message and generates a response if needed.
   - **Description**: This function determines whether to respond to a message based on triggers, random probability, and bot configurations. It utilizes the `LLMService` to generate responses.

3. **Database Interactions**
   - **File**: `services/database.ts`
   - **Functions**: 
     - `getAllBotConfigs()`: Fetches all bot configurations.
     - `getBotConfigByAlias(alias: string)`: Retrieves a bot configuration by its alias.
     - `getServerBots(serverId: string)`: Fetches all bot configurations enabled for a specific server.
     - `enableBotForServer(serverId: string, alias: string)`: Enables a bot for a specific server.
     - `getServerByDiscordId(discordServerId: string)`: Retrieves a server record by its Discord ID.
     - `updateServerInfo(serverId: string, name: string)`: Updates server information.
   - **Description**: These functions handle CRUD operations for bot configurations and server information within the Supabase database.

4. **LLM Response Generation**
   - **File**: `services/llm.ts`
   - **Functions**: 
     - `generateResponse(botConfig: BotConfig, messages: Array<{ role: string; content: string }>)`: Generates a response from an LLM.
   - **Description**: This function handles the decryption of API keys, adds system prompts, and routes the request to the appropriate LLM API based on the bot configuration.

### Complex Business Logic
- **Bot Message Processing** (`services/discord.ts`):
  - **Function**: `processMessage`
  - **Description**: Determines whether to respond to a message based on predefined triggers, random probability, and bot configurations. It integrates with the LLM service to generate contextually appropriate responses.

- **LLM Response Generation** (`services/llm.ts`):
  - **Function**: `generateResponse`
  - **Description**: Manages the decryption of API keys, constructs system prompts, and routes requests to different LLM providers based on bot configurations.

## Architecture
### Data Flow Overview
1. **Command Execution**:
   - Users issue commands via Discord (e.g., enabling a bot personality).
   - Commands are handled by respective modules in the `commands` directory (e.g., `commands/config.ts`).
   - These modules interact with the `DiscordService` to perform actions and update the database as needed.

2. **Event Handling**:
   - Discord events (e.g., message creation) are captured by event handlers in the `events` directory (e.g., `events/messageCreate.ts`).
   - The `DiscordService` processes these events, determining whether to generate a response and interacting with the LLM service if necessary.

3. **Database Interactions**:
   - All database operations are managed through the `DatabaseService` (`services/database.ts`).
   - The service performs CRUD operations to maintain bot configurations and server information.

4. **LLM Integration**:
   - Responses are generated by the `LLMService` (`services/llm.ts`), which interacts with external LLM APIs.
   - The service handles API key decryption and constructs requests to LLM providers.

5. **Initialization and Lifecycle Management**:
   - The bot is initialized and its lifecycle is managed in `index.ts`.
   - Environment variables are loaded, events and commands are registered, and the Discord client is logged in.